- 1. External to DA, the OS X Way Operating in an OS X-heavy environment - 2. Contents Introduction Overview Tradecraft Preparation Challenges The Agent Phishing Situational Awareness: Host Enumeration Privilege Escalation Persistence Situational Awareness: Network and User Enumeration Lateral Movement - 3. Introductions Alex Rymdeko-Harvey is a previous US Army Solider that recently transitioned and currently works at the Adaptive Threat Division at Veris Group as a Penetration Tester and Red Teamer. Alex has a wide range of skills and experience from offensive and defensive operations taking place in today's security surface. Steve Borosh is a long-time security enthusiast. Prior: U.S. Army Infantry Combat Veteran and private security contractor. Currently working as a Penetration Tester, Red Teamer and Instructor with Veris Group’s Adaptive Threat Division. Steve enjoys bug hunting, building useful security tools and teaching. - 4. Overview • Typical penetration tests cover Windows / Linux • Assessments become mundane • Client approaches with a large OS X user-base • Use common methodologies with new tools and techniques adapted for OS X • Utilize EmPyre, a Remote Access Trojan based of of the Empire framework - 5. Adversarial Use • WireLurker (Trojanized applications, Infects connected ios devices) • XcodeGhost (Infected xcode package in China) • Hacking Team (Remote Code Systems compromise platform) • OceanLotus (Flash Dropper, Download Mach-O binary) • KeRanger (Ransomware, Infected transmission package) - 6. The Scenario • A client requests an external penetration test against their corporate infrastructure. • Phishing with payloads may be conducted with email addresses harvested from publicly available sources. • 90% of users utilize OS X with several developers using Windows - 7. Scenario: Goals • Phish OS X users • Elevate local privileges • Move Laterally if needed • Gain control of the Active Directory domain - 8. Tradecraft Preparation • Planning and Preparation • Right tools for the job • Live off the land • pbpaste • screencapture • Native vs Non-Native • Methodology • Reconnaissance • Exploitation (gain access) • Sitiuational Awareness • Escalate Privileges • Establish Persistence • Lateral Movement Gain Access Situational Awareness Escalate Privileges Establish Persistence Lateral Movement - 9. Challenges Limited information on operating in OS X environments No open-sourced asynchronous Remote Access Trojan (RAT) Lateral Spread OS X/Linux Windows Less phishing payloads available No OLE Less executable types - 10. The Agent: EmPyre - 11. The Agent: EmPyre Remote Access Trojan (RAT) Python (core developed by @harmj0y) based on the Empire project Asynchronous / C2 Secure Diffie-Hellman exchange communications Post-Exploitation modules OS X/Linux Launcher detects Little Snitch - 12. The Agent: EmPyre The Diffie Hellman implementation is from Mark Loiseau's project at https://github.com/lowazo/pyDHE, licensed under version 3.0 of the GNU General Public License. The AES implementation is adapted from Richard Moore's project at https://github.com/ricmoo/pyaes, licensed under the MIT license. - 13. Phishing Previous Tradecraft Browser Exploits Java Payloads OLE Documents Macro Payloads - 14. Phishing: Payload Generation 2015-7007 HTML Applescript launcher OS X Microsoft Office Macro Supports 2011 2016 = “Sandbox” - 15. Payload Generation - 16. Situational Awareness: Host Previous Tradecraft PowerShell WMI PowerUp Cobalt Strike Beacon modules Meterpreter modules The core of knowing your land How do we priv-esc? - 17. Situational Awareness: Host Keylog Keychain Dump Clipboard Monitoring Scrape Messages Hash Dump Browser Dump - 18. Situational Awareness: Keylogging Elevated Context Vital portion of our tradecraft post exploitation - 19. Situational Awareness: Clipboard Monitoring Non-Native method Native pbpaste may be signatured by Carbon Black Out to file - 20. Situational Awareness: Keychain Dump Cleartext Keychain Dump Versions Prior to OS X El Capitan Inspired / Adapted from Juuso: https://github.com/juuso /keychaindump - 21. Situational Awareness: Search Messages Scrapes Message.app DB iMessage, Jabber, Google Talk, Yahoo, AIM Enumerate X messages Account Service Number message - 22. Situational Awareness: Hashdump Local Hashes Hashcat format ready! - 23. Situational Awareness: Browser Dump Dump Chrome Dump Safari Specify length of output - 24. Privilege Escalation Sudo Spawn - 25. Persistence Previous Tradecraft Windows Registry Startup Folders WMI DLL Hijack Net user /add Linux Crontab adduser - 26. Persistence Login Hooks Login persistence Crontab Hourly persistence LaunchDaemon Reboot persistence DyLib Hijacking Application start persistence - 27. Persistence: Login Hook - User Context Persistence Mac Login Hooks Bash / Applescript execution Accessible to all users Uses “Defaults” tool Sets com.apple.loginwindow LoginHook - 28. Persistence: Crontab Set persistence by time Requires file on disk - 29. Persistence: Launch Daemon Requires Sudo Spawns on reboot Spawns on agent loss - 30. Persistence: Dylib Hijacking Hijack Scanner Module Based on @patrickwardle research - 31. Persistence: Dylib Hijacking Hijacked Xcode - 32. Situational Awareness: Network Previous Tradecraft Arp Nmap Net Commands EyeWitness PowerView - 33. Situational Awareness: Network Group Policy Preferences Active Directory Queries Port Scanning Web Discovery - 34. Situational Awareness: Active Directory Modules situational_awareness/network/active_directory/get_computers situational_awareness/network/active_directory/get_domaincontrollers situational_awareness/network/active_directory/get_fileservers situational_awareness/network/active_directory/get_groupmembers situational_awareness/network/active_directory/get_groupmemberships situational_awareness/network/active_directory/get_groups situational_awareness/network/active_directory/get_ous situational_awareness/network/active_directory/get_userinformation situational_awareness/network/active_directory/get_users - 35. Situational Awareness: GPP Group Policy Preferences Pulls “Encrypted” passwords from SYSVOL MS14-025 https://raw.githubusercontent.com/leonteale/pentestpackage/master/Gpprefdecrypt.py - 36. Situational Awareness: Finding the Domain Controller - 37. Situational Awareness: LDAP Queries Utilizes LDAP queries to pull objects such as computers, users, groups and more from Active Directory. - 38. Situational Awareness: Web Services find_fruit module Checks for possible vulnerable web applications Tomcat jboss idrac Apache Axis2 etc.. - 39. Lateral Movement Previous Tradecraft Linux SSH Telnet Exploitation Windows PSEXEC WMI Exploitation RDP - 40. Lateral Movement Windows Pivot to “Empire” Exploit Web Services - 41. Lateral Movement Linux/OS X SSH Commands SSH Launcher - 42. Honorable Mention: REST API EmPyre implements the same RESTful API specification as Empire https://github.com/PowerShellEmpire/Empire/wiki/RESTful-API External users/projects can fully control an EmPyre server in a predictable way REST requests This opens the possibility for web front ends, Android apps, multi- player CLI UIs, and more - 43. What’s next Socks Proxy Community Modules More Exploitation Modules Merge with Empire Thanks to @harmj0y, @xorrior, @CptJesus for their contributions to this effort! Steve starts talking Introduce ourselves As a Penetration Tester or Red Teamer, the path to Domain Administrator in many environments may seem all too easy or “cookie cutter” these days. But what happens when you engage a high-security client with an OS X-heavy environment? Do you turn down the engagement or accept the challenge and up your game? This talk explores such a scenario and how testers can utilize various tools, techniques, and lessons-learned to successfully perform a complete assessment in an OS X domain-joined environment. We will cover a custom-built OS X/Linux agent and its associated tradecraft, from gaining initial access, to post-exploitation, lateral spread, persistence, and domain compromise. Keep in mind, methodologies stay the same for OS X, tradecraft may change. Explain such as “How do we gain access in OS X”? SSH/Phishing. Different operating systems present their own lateral spread challenges. (linux: no smb, wmi, powershell) (Windows: no ssh, OS X doesnt have net commands) Alex Start Familiar interface for Empire users. Currently ,we have two payloads for phishing. Talk about tradecraft as a whole, This is post exploitation enumeration Keychain Dump - No el Capitan YET Currently saves to target in an unencrypted format. Talk about how messages are stored unencrypted in a database Currently, only dumps history. Useful for hunting internal web services. Steve Starts Utilizes “ldapsearch” for AD enumeration In order to perform LDAP queries we’ll need to start off by finding the domain controller that we are going to bind our LDAP queries to. One quick solution is a single nslookup query. During most penetration tests, you may find yourself moving from host to host using common techniques such as PSEXEC, WMI or RDP. Operating in an OS X environment presents challenges as these methods may not be available.