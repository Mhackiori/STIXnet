Identifying and Mitigating Exploitation of the SNMP Version 3 Authentication Vulnerabilities Advisory ID: cisco-amb-20080610-SNMPv3 http://tools.cisco.com/security/center/content/CiscoAppliedMitigationBulletin/cisco-amb-20080610-SNMPv3 Revision 1.1 For Public Release 2008 June 10 16:00 UTC (GMT) Related Resources: ContentsCisco Response Device-Specific Mitigation and Identification Additional Information Revision History Cisco Security Procedures Related Information Cisco Response This Applied Mitigation Bulletin is a companion document to the PSIRT Security Advisory SNMP Version 3 Authentication Vulnerabilities and provides identification and mitigation techniques that administrators can deploy on Cisco network devices. The United States Computer Emergency Response Team (US-CERT) has assigned Vulnerability Note VU#878044 to these vulnerabilities. Vulnerability Characteristics Simple Network Management Protocol version 3 (SNMPv3) authentication code contains vulnerabilities when processing a malformed SNMPv3 packet that manipulates the Hash Message Authentication Code (HMAC). These vulnerabilities can be exploited remotely without authentication and without end-user interaction. Successful exploitation of these vulnerabilities may allow an attacker to masquerade as a valid device and establish SNMPv3 sessions. The attack vector for exploitation is through a SNMPv3 packet using UDP port 161. An attacker could exploit these vulnerabilities using spoofed packets. These vulnerabilities have been assigned CVE identifier CVE-2008-0960. Vulnerable, non-affected and fixed software information is available in the PSIRT Security Advisory: http://tools.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-20080610-snmpv3. Mitigation Technique Overview Cisco devices provide several countermeasures for these vulnerabilities. Administrators are advised to consider these protection methods to be general security best practices for infrastructure devices and the traffic that transits the network. This section of the document provides an overview of these techniques. Cisco IOS Software can provide effective means of exploit prevention using the following methods: - Infrastructure access control lists (iACLs) - Transit access control lists (tACLs) - Unicast Reverse Path Forwarding (Unicast RPF) - IP source guard (IPSG) These protection mechanisms filter and drop, as well as verify the source IP address of, packets that are attempting to exploit these vulnerabilities. The proper deployment and configuration of Unicast RPF provides an effective means of protection against attacks that use packets with spoofed source IP addresses. Unicast RPF should be deployed as close to all traffic sources as possible. The proper deployment and configuration of IPSG provides an effective means of protection against spoofing attacks at the access layer. Effective means of exploit prevention can also be provided by Cisco ASA 5500 Series Adaptive Security Appliance, Cisco PIX 500 Series Security Appliance, and the Firewall Services Module (FWSM) for Cisco Catalyst 6500 Series switches and Cisco 7600 Series routers using the following: - tACLs - Application layer protocol inspection - Unicast RPF These protection mechanisms filter and drop, as well as verify the source IP address of, packets that are attempting to exploit these vulnerabilities. Cisco IOS NetFlow can provide visibility into network-based exploitation attempts using flow records. Cisco IOS Software, Cisco ASA, Cisco PIX security appliances, and FWSM firewalls can provide visibility through syslog messages and the counter values displayed in the output from show commands. Effective use of Cisco Intrusion Prevention System (IPS) event actions provides visibility into and protection against attacks that attempt to exploit this vulnerability as discussed later in this document. The Cisco Security Monitoring, Analysis, and Response System (Cisco Security MARS) appliance can also provide visibility through incidents, queries, and event reporting. Risk Management Organizations are advised to follow their standard risk evaluation and mitigation processes to determine the potential impact of these vulnerabilities. Triage refers to sorting projects and prioritizing efforts that are most likely to be successful. Cisco has provided documents that can help organizations develop a risk-based triage capability for their information security teams. Risk Triage for Security Vulnerability Announcements and Risk Triage and Prototyping can help organizations develop repeatable security evaluation and response processes. Device-Specific Mitigation and Identification Caution: The effectiveness of any mitigation technique is dependent on specific customer situations such as product mix, network topology, traffic behavior, and organizational mission. As with any configuration change, evaluate the impact of this configuration prior to applying the change. Specific information about mitigation and identification is available for these devices: - Cisco IOS Routers and Switches - Cisco IOS NetFlow - Cisco ASA, PIX, and FWSM Firewalls - Cisco Intrusion Prevention System - Cisco Security Monitoring, Analysis, and Response System Cisco IOS Routers and Switches Mitigation: Infrastructure Access Control Lists To protect infrastructure devices and minimize the risk, impact, and effectiveness of direct infrastructure attacks, administrators are advised to deploy infrastructure access control lists (iACLs) to perform policy enforcement of traffic sent to infrastructure equipment. Administrators can construct an iACL by explicitly permitting only authorized traffic sent to infrastructure devices in accordance with existing security policies and configurations. For the maximum protection of infrastructure devices, deployed iACLs should be applied in the ingress direction on all interfaces to which an IP address has been configured. An iACL workaround cannot provide complete protection against these vulnerabilities when the attack comes from a trusted source address. The iACL policy denies unauthorized SNMP packets on UDP port 161 that are sent to affected devices. In the following example, 192.168.60.0/24 is the IP address space that is used by the affected devices, and the host at 192.168.100.1 is considered a trusted source that requires access to the affected devices. Care should be taken to allow required traffic for routing and administrative access prior to denying all unauthorized traffic. Whenever possible, infrastructure address space should be distinct from the address space used for user and services segments. Using this addressing methodology will assist with the construction and deployment of iACLs. Additional information about iACLs is available in Protecting Your Core: Infrastructure Protection Access Control Lists. ip access-list extended iACL-Policy ! !--- When applicable, include explicit permit statements for trusted !--- sources that require access on the vulnerable port ! permit udp host 192.168.100.1 192.168.60.0 0.0.0.255 eq 161 ! !--- The following vulnerability-specific access control entry !--- (ACE) can aid in identification of attacks ! deny udp any 192.168.60.0 0.0.0.255 eq 161 ! !--- Explicit deny ACE for traffic sent to addresses configured within !--- the infrastructure address space ! deny ip any 192.168.60.0 0.0.0.255 ! !--- Permit/deny all other Layer 3 and Layer 4 traffic in accordance !--- with existing security policies and configurations ! !--- Apply iACL to interfaces in the ingress direction interface GigabitEthernet0/0 ip access-group iACL-Policy in ! Note: Filtering with an interface access list will elicit the transmission of ICMP unreachable messages back to the source of the filtered traffic. Generating these messages could have the undesired effect of increasing CPU utilization on the device. In Cisco IOS Software, ICMP unreachable generation is limited to one packet every 500 milliseconds by default. ICMP unreachable message generation can be disabled using the interface configuration command no ip unreachables. ICMP unreachable rate limiting can be changed from the default using the global configuration command ip icmp rate-limit unreachable interval-in-ms. Mitigation: Transit Access Control Lists To protect the network from traffic that enters the network at ingress access points, which may include Internet connection points, partner and supplier connection points, or VPN connection points, administrators are advised to deploy transit access control lists (tACLs) to perform policy enforcement. Administrators can construct a tACL by explicitly permitting only authorized traffic to enter the network at ingress access points or permitting authorized traffic to transit the network in accordance with existing security policies and configurations. A tACL workaround cannot provide complete protection against these vulnerabilities when the attack comes from a trusted source address. The tACL policy denies unauthorized SNMP packets on UDP port 161 that are sent to affected devices. In the following example, 192.168.60.0/24 is the IP address space that is used by the affected devices, and the host at 192.168.100.1 is considered a trusted source that requires access to the affected devices. Care should be taken to allow required traffic for routing and administrative access prior to denying all unauthorized traffic. Additional information about tACLs is available in Transit Access Control Lists: Filtering at Your Edge. !--- Include any explicit permit statements for trusted sources !--- that require access on the vulnerable port ! access-list 150 permit udp host 192.168.100.1 192.168.60.0 0.0.0.255 eq 161 ! !--- The following vulnerability-specific access control entry !--- (ACE) can aid in identification of attacks ! access-list 150 deny udp any 192.168.60.0 0.0.0.255 eq 161 ! !--- Permit/deny all other Layer 3 and Layer 4 traffic in accordance !--- with existing security policies and configurations ! !--- Explicit deny for all other IP traffic ! access-list 150 deny ip any any ! !--- Apply tACL to interfaces in the ingress direction interface GigabitEthernet0/0 ip access-group 150 in ! Note: Filtering with an interface access list will elicit the transmission of ICMP unreachable messages back to the source of the filtered traffic. Generating these messages could have the undesired effect of increasing CPU utilization on the device. In Cisco IOS Software, ICMP unreachable generation is limited to one packet every 500 milliseconds by default. ICMP unreachable message generation can be disabled using the interface configuration command no ip unreachables. ICMP unreachable rate limiting can be changed from the default using the global configuration command ip icmp rate-limit unreachable interval-in-ms. Mitigation: Spoofing Protection Unicast Reverse Path Forwarding The vulnerabilities described in this document can be exploited by spoofed IP packets. Administrators can deploy and configure Unicast Reverse Path Forwarding (Unicast RPF) as a protection mechanism against spoofing. Unicast RPF is configured at the interface level and can detect and drop packets that lack a verifiable source IP address. Administrators should not rely on Unicast RPF to provide complete spoofing protection because spoofed packets may enter the network through a Unicast RPF-enabled interface if an appropriate return route to the source IP address exists. Administrators are advised to take care to ensure that the appropriate Unicast RPF mode (loose or strict) is configured during the deployment of this feature because it can drop legitimate traffic that is transiting the network. In an enterprise environment, Unicast RPF might be enabled at the Internet edge and the internal access layer on the user-supporting Layer 3 interfaces. Additional information is available in the Unicast Reverse Path Forwarding Loose Mode Feature Guide. For additional information about the configuration and use of Unicast RPF, reference the Understanding Unicast Reverse Path Forwarding Applied Intelligence white paper. IP Source Guard IP source guard (IPSG) is a security feature that restricts IP traffic on nonrouted, Layer 2 interfaces by filtering packets based on the DHCP snooping binding database and manually configured IP source bindings. Administrators can use IPSG to prevent attacks from an attacker who attempts to spoof packets by forging the source IP address and/or the MAC address. When properly deployed and configured, IPSG coupled with strict mode Unicast RPF provides the most effective means of spoofing protection for these vulnerabilities. Additional information about the deployment and configuration of IPSG is available in Configuring DHCP Features and IP Source Guard. Identification: Infrastructure Access Control Lists After the administrator applies the iACL to an interface, the show ip access-lists command will identify the number of SNMP packets on UDP port 161 (snmp) that have been filtered on interfaces on which the iACL is applied. Administrators should investigate filtered packets to determine whether they are attempts to exploit these vulnerabilities. Example output for show ip access-lists iACL-Policy follows: router#show ip access-lists iACL-Policy Extended IP access list iACL-Policy 10 permit udp host 192.168.100.1 192.168.60.0 0.0.0.255 eq snmp 20 deny udp any 192.168.60.0 0.0.0.255 eq snmp (13 matches) 30 deny ip any 192.168.60.0 0.0.0.255 router# In the preceding example, access list iACL-Policy has dropped 13 SNMP packets on UDP port 161 (snmp) for ACE line 20. For additional information about investigating incidents using ACE counters and syslog events, reference the Identifying Incidents Using Firewall and IOS Router Syslog Events Applied Intelligence white paper. Administrators can use Embedded Event Manager to provide instrumentation when specific conditions are met, such as ACE counter hits. The Applied Intelligence white paper Embedded Event Manager in a Security Context provides additional details about how to use this feature. Identification: Transit Access Control Lists After the administrator applies the tACL to an interface, the show ip access-lists command will identify the number of SNMP packets on UDP port 161 (snmp) that have been filtered. Administrators are advised to investigate filtered packets to determine whether they are attempts to exploit these vulnerabilities. Example output for show ip access-lists 150 follows: router#show ip access-lists 150 Extended IP access list 150 10 permit udp host 192.168.100.1 192.168.60.0 0.0.0.255 eq snmp 20 deny udp any 192.168.60.0 0.0.0.255 eq snmp (26 matches) 30 deny ip any any router# In the preceding example, access list 150 has dropped 26 SNMP packets on UDP port 161 (snmp) for ACE line 20. For additional information about investigating incidents using ACE counters and syslog events, reference the Identifying Incidents Using Firewall and IOS Router Syslog Events Applied Intelligence white paper. Administrators can use Embedded Event Manager to provide instrumentation when specific conditions are met, such as ACE counter hits. The Applied Intelligence white paper Embedded Event Manager in a Security Context provides additional details about how to use this feature. Identification: Access List Logging The log and log-input access control list (ACL) option will cause packets that match specific ACEs to be logged. The log-input option enables logging of the ingress interface in addition to the packet source and destination IP addresses and ports. Caution: Access control list logging can be very CPU intensive and must be used with extreme caution. Factors that drive the CPU impact of ACL logging are log generation, log transmission, and process switching to forward packets that match log-enabled ACEs. For Cisco IOS Software, the ip access-list logging interval interval-in-ms command can limit the effects of process switching induced by ACL logging. The logging rate-limit rate-per-second [except loglevel] command limits the impact of log generation and transmission. The CPU impact from ACL logging can be addressed in hardware on the Cisco Catalyst 6500 Series switches and Cisco 7600 Series routers with Supervisor Engine 720 or Supervisor Engine 32 using optimized ACL logging. For additional information about the configuration and use of ACL logging, reference the Understanding Access Control List Logging Applied Intelligence white paper. Identification: Spoofing Protection Using Unicast Reverse Path Forwarding With Unicast RPF properly deployed and configured throughout the network infrastructure, administrators can use the show cef interface type slot/port internal , show ip interface , show cef drop , and show ip traffic commands to identify the number of packets that Unicast RPF has dropped. Note: The show command | begin regex and show command | include regex command modifiers are used in the following examples to minimize the amount of output that administrators will need to parse to view the desired information. Additional information about command modifiers is available in the show command sections of the Cisco IOS Configuration Fundamentals Command Reference. router#show cef interface GigabitEthernet 0/0 internal | include drop -- CLI Output Truncated -- ip verify: via=rx (allow default), acl=0, drop=11, sdrop=0 router# Note: show cef interface type slot/port internal is a hidden command that must be fully entered at the command-line interface. Command completion is not available for it. router#show ip interface GigabitEthernet 0/0 | begin verify -- CLI Output Truncated -- ip verify source reachable-via RX, allow default, allow self-ping 11 verification drops 0 suppressed verification drops router# router#show cef drop CEF Drop Statistics Slot Encap_fail Unresolved Unsupported No_route No_adj ChkSum_Err RP 27 0 0 18 0 0 router# router#show ip traffic IP statistics: Rcvd: 68051015 total, 2397325 local destination 43999 format errors, 0 checksum errors, 33 bad hop count 2 unknown protocol, 929 not a gateway 21 security failures, 190123 bad options, 542768 with options Opts: 352227 end, 452 nop, 36 basic security, 1 loose source route 45 timestamp, 59 extended security, 41 record route 53 stream ID, 3 strict source route, 40 alert, 45 cipso, 0 ump 361634 other Frags: 0 reassembled, 10008 timeouts, 56866 couldn't reassemble 0 fragmented, 0 fragments, 0 couldn't fragment Bcast: 64666 received, 0 sent Mcast: 1589885 received, 2405454 sent Sent: 3001564 generated, 65359134 forwarded Drop: 4256 encapsulation failed, 0 unresolved, 0 no adjacency 18 no route, 18 unicast RPF, 0 forced drop 0 options denied Drop: 0 packets with source IP address zero Drop: 0 packets with internal loop back IP address -- CLI Output Truncated -- router# In the preceding show cef drop and show ip traffic examples, Unicast RPF has dropped 18 IP packets received globally on all interfaces with Unicast RPF configured because of the inability to verify the source address of the IP packets within the Cisco Express Forwarding Forwarding Information Base. Cisco IOS NetFlow Identification: Traffic Flow Identification Using NetFlow Records Administrators can configure Cisco IOS NetFlow on Cisco IOS routers and switches to aid in the identification of traffic flows that may be attempts to exploit these vulnerabilities. Administrators are advised to investigate flows to determine whether they are attempts to exploit these vulnerabilities or whether they are legitimate traffic flows. router#show ip cache flow IP packet size distribution (11206278 total packets): 1-32 64 96 128 160 192 224 256 288 320 352 384 416 448 480 .987 .000 .000 .012 .000 .000 .000 .000 .000 .000 .000 .000 .000 .000 .000 512 544 576 1024 1536 2048 2560 3072 3584 4096 4608 .000 .000 .000 .000 .000 .000 .000 .000 .000 .000 .000 IP Flow Switching Cache, 278544 bytes 5 active, 4092 inactive, 666 added 632544 ager polls, 0 flow alloc failures Active flows timeout in 30 minutes Inactive flows timeout in 15 seconds IP Sub Flow Cache, 25800 bytes 1 active, 1023 inactive, 349 added, 349 added to flow 0 alloc failures, 0 force free 1 chunk, 1 chunk added last clearing of statistics never Protocol Total Flows Packets Bytes Packets Active(Sec) Idle(Sec) -------- Flows /Sec /Flow /Pkt /Sec /Flow /Flow TCP-WWW 2 0.0 2 52 0.0 0.2 1.4 TCP-other 142 0.0 1 58 0.0 0.5 15.4 UDP-other 5 0.0 1963827 28 15.6 19.8 15.3 ICMP 165 0.0 1 92 0.0 0.0 15.4 IP-other 349 0.0 388 99 0.2 1793.1 2.2 Total: 663 0.0 15015 28 15.8 944.1 8.4 SrcIf SrcIPaddress DstIf DstIPaddress Pr SrcP DstP Pkts Gi0/1 10.89.236.137 Null 224.0.0.10 58 0000 0000 130 Gi0/1 192.168.60.1 Gi0/0 192.168.60.27 11 0675 00A1 368K Gi0/1 192.168.60.1 Gi0/0 192.168.60.53 11 0675 00A1 1043K Gi0/1 192.168.60.1 Gi0/0 192.168.60.19 11 0675 00A1 4821K Gi0/1 192.168.60.1 Gi0/0 192.168.60.72 11 0675 00A1 398K Gi0/1 192.168.60.1 Gi0/0 192.168.60.48 11 0675 00A1 544K Gi0/0 10.88.226.1 Gi0/1 192.168.202.22 11 007B 007B 1 Gi0/1 192.168.150.60 Gi0/0 10.89.16.226 06 0016 12CA 1 Gi0/0 10.89.16.226 Gi0/1 192.168.150.60 06 12CA 0016 1 router# In the preceding example, there are multiple flows for SNMP on UDP port 161 (hex value 00A1). This traffic is sourced from and sent to addresses within the 192.168.60.0/24 address block, which is used by affected devices. The packets in these flows may be spoofed and may indicate an attempt to exploit these vulnerabilities. Administrators are advised to compare these flows to baseline utilization for SNMP traffic sent on UDP port 161 and also investigate the flows to determine whether they are sourced from untrusted hosts or networks. To view only the traffic flows for SNMP packets on UDP port 161 (hex value 00A1), the command show ip cache flow | include SrcIf|_11_.*00A1 will display the related UDP NetFlow records as shown here: router#show ip cache flow | include SrcIf|_11_.*00A1 SrcIf SrcIPaddress DstIf DstIPaddress Pr SrcP DstP Pkts Gi0/1 192.168.60.1 Gi0/0 192.168.60.27 11 0675 00A1 368K Gi0/1 192.168.60.1 Gi0/0 192.168.60.53 11 0675 00A1 1043K Gi0/1 192.168.60.1 Gi0/0 192.168.60.19 11 0675 00A1 4821K Gi0/1 192.168.60.1 Gi0/0 192.168.60.72 11 0675 00A1 398K Gi0/1 192.168.60.1 Gi0/0 192.168.60.48 11 0675 00A1 544K Cisco ASA, PIX, and FWSM Firewalls Mitigation: Transit Access Control Lists To protect the network from traffic that enters the network at ingress access points, which may include Internet connection points, partner and supplier connection points, or VPN connection points, administrators are advised to deploy tACLs to perform policy enforcement. Administrators can construct a tACL by explicitly permitting only authorized traffic to enter the network at ingress access points or permitting authorized traffic to transit the network in accordance with existing security policies and configurations. A tACL workaround cannot provide complete protection against these vulnerabilities when the attack originates from a trusted source address. The tACL policy denies unauthorized SNMP packets on UDP port 161 that are sent to affected devices. In the following example, 192.168.60.0/24 is the IP address space that is used by the affected devices, and the host at 192.168.100.1 is considered a trusted source that requires access to the affected devices. Care should be taken to allow required traffic for routing and administrative access prior to denying all unauthorized traffic. Additional information about tACLs is available in Transit Access Control Lists: Filtering at Your Edge. ! !--- Include any explicit permit statements for trusted sources !--- requiring access on the vulnerable port ! access-list tACL-Policy extended permit udp host 192.168.100.1 192.168.60.0 255.255.255.0 eq 161 ! !--- The following vulnerability-specific access control entry !--- (ACE) can aid in identification of attacks ! access-list tACL-Policy extended deny udp any 192.168.60.0 255.255.255.0 eq 161 ! !--- Permit/deny all other Layer 3 and Layer 4 traffic in accordance !--- with existing security policies and configurations ! !--- Explicit deny for all other IP traffic ! access-list tACL-Policy extended deny ip any any ! !--- Apply tACL to interface(s) in the ingress direction ! access-group tACL-Policy in interface outside ! Mitigation: Application Layer Protocol Inspection Application layer protocol inspection is available beginning in software release 7.0 for the Cisco ASA 5500 Series Adaptive Security Appliance and Cisco PIX 500 Series Security Appliance. This advanced security feature performs deep packet inspection of traffic transiting through the firewall. Administrators may construct an inspection policy for applications that require special handling through the configuration of inspect class maps and inspect policy maps, which are applied via a global or an interface service policy. Additional information about application layer protocol inspection is available in Applying Application Layer Protocol Inspection. Caution: Application layer protocol inspection will decrease firewall performance. Performance impact should be tested in a lab environment before deployment in production environments. SNMP Inspection By using the SNMP inspection engine on Cisco ASA 5500 Series Adaptive Security Appliances and Cisco PIX 500 Series Security Appliances, administrators can configure a policy that prevents SNMPv3 messages while allowing SNMPv1, SNMPv2, and SNMPv2c messages to transit the firewall. The following SNMP inspection uses the Modular Policy Framework (MPF) to create a policy for inspection of traffic on UDP port 161. The SNMP inspection policy will drop SNMPv3 connections. ! !--- Configure an SNMP map to deny SNMPv3 connections ! snmp-map deny_snmpv3 deny version 3 ! !--- Add the above configured SNMP map to the default policy !--- global_policy and default class inspection_default !--- and use it to inspect SNMP traffic transiting the firewall ! policy-map global_policy class inspection_default inspect snmp deny_snmpv3 ! !--- By default, the policy global_policy is applied globally, resulting in !--- inspection of traffic entering the firewall from all interfaces ! service-policy global_policy global Additional information about SNMP Application Inspection and the Modular Policy Framework is available in the Cisco Security Appliance Command Line Configuration Guide SNMP Inspection. Mitigation: Spoofing Protection Using Unicast Reverse Path Forwarding The vulnerabilities can be exploited by spoofed IP packets. Administrators can deploy and configure Unicast RPF as a protection mechanism against spoofing. Unicast RPF is configured at the interface level and can detect and drop packets that lack a verifiable source IP address. Administrators should not rely on Unicast RPF to provide complete spoofing protection because spoofed packets may enter the network through a Unicast RPF-enabled interface if an appropriate return route to the source IP address exists. In an enterprise environment, Unicast RPF might be enabled at the Internet edge and at the internal access layer on the user-supporting Layer 3 interfaces. For additional information about the configuration and use of Unicast RPF, reference the Cisco Security Appliance Command Reference for ipverify reverse-path and the Understanding Unicast Reverse Path Forwarding Applied Intelligence white paper. Identification: Transit Access Control Lists After the tACL has been applied to an interface, administrators can use the show access-list command to identify the number of SNMP packets on UDP port 161 (snmp) that have been filtered. Administrators are advised to investigate filtered packets to determine whether they are attempts to exploit these vulnerabilities. Example output for show access-list tACL-Policy follows: firewall#show access-list tACL-Policy access-list tACL-Policy; 3 elements access-list tACL-Policy line 1 extended permit udp host 192.168.100.1 192.168.60.0 255.255.255.0 eq snmp (hitcnt=34) access-list tACL-Policy line 2 extended deny udp any 192.168.60.0 255.255.255.0 eq snmp (hitcnt=119) access-list tACL-Policy line 3 extended deny ip any any (hitcnt=8) firewall# In the preceding example, access list tACL-Policy has dropped 119 SNMP packets on UDP port 161 (snmp) received from an untrusted host or network. In addition, syslog message 106023 can provide valuable information, which includes the source and destination IP address, the source and destination port numbers, and the IP protocol for the denied packet. Identification: Firewall Access List Syslog Messages Firewall syslog message 106023 will be generated for packets denied by an access control entry (ACE) that does not have the log keyword present. Additional information about this syslog message is available in Cisco Security Appliance System Log Message - 106023. Information about configuring syslog for the Cisco ASA 5500 Series Adaptive Security Appliance or the Cisco PIX 500 Series Security Appliance is available in Monitoring the Security Appliance - Configuring and Managing Logs. Information about configuring syslog on the FWSM for Cisco Catalyst 6500 Series switches and Cisco 7600 Series routers is available in Configuring Monitoring and Logging on the Cisco FWSM. In the following example, the show logging | grep regex command extracts syslog messages from the logging buffer on the firewall. These messages provide additional information about denied packets that could indicate potential attempts to exploit the vulnerabilities described in this document. It is possible to use different regular expressions with the grep keyword to search for specific data in the logged messages. Additional information about regular expression syntax is available in Using the Command Line Interface. firewall#show logging | grep 106023 Jun 05 2008 19:25:16: %PIX-4-106023: Deny udp src outside:192.168.60.1/1653 dst inside:192.168.60.57/161 by access-group "tACL-Policy" Jun 05 2008 19:25:16: %PIX-4-106023: Deny udp src outside:192.168.60.1/1654 dst inside:192.168.60.58/161 by access-group "tACL-Policy" Jun 05 2008 19:25:16: %PIX-4-106023: Deny udp src outside:192.168.60.1/1655 dst inside:192.168.60.59/161 by access-group "tACL-Policy" Jun 05 2008 19:25:16: %PIX-4-106023: Deny udp src outside:192.168.60.1/1656 dst inside:192.168.60.60/161 by access-group "tACL-Policy" Jun 05 2008 19:25:16: %PIX-4-106023: Deny udp src outside:192.168.60.1/1657 dst inside:192.168.60.61/161 by access-group "tACL-Policy" Jun 05 2008 19:25:16: %PIX-4-106023: Deny udp src outside:192.168.60.1/1658 dst inside:192.168.60.62/161 by access-group "tACL-Policy" Jun 05 2008 19:25:16: %PIX-4-106023: Deny udp src outside:192.168.60.1/1659 dst inside:192.168.60.63/161 by access-group "tACL-Policy" Jun 05 2008 19:25:16: %PIX-4-106023: Deny udp src outside:192.168.60.1/1660 dst inside:192.168.60.64/161 by access-group "tACL-Policy" Jun 05 2008 19:25:16: %PIX-4-106023: Deny udp src outside:192.168.60.1/1661 dst inside:192.168.60.65/161 by access-group "tACL-Policy" firewall# In the preceding example, the messages logged for the tACL tACL-Policy show potentially spoofed SNMP packets for UDP port 161 sent to the address block assigned to affected devices. Additional information about syslog messages for ASA and PIX security appliances is available in Cisco Security Appliance System Log Messages. Additional information about syslog messages for the FWSM is available in Catalyst 6500 Series Switch and Cisco 7600 Series Router Firewall Services Module Logging Configuration and System Log Messages. For additional information about investigating incidents using syslog events, reference the Identifying Incidents Using Firewall and IOS Router Syslog Events Applied Intelligence white paper. Identification: Application Layer Protocol Inspection Firewall syslog message 416001 will be generated when an SNMP packet is dropped. The syslog message will identify the SNMP version of the dropped packet. Additional information about this syslog message is available in Cisco Security Appliance System Log Message - 416001. Information about configuring syslog for the Cisco ASA 5500 Series Adaptive Security Appliance or the Cisco PIX 500 Series Security Appliance is available in Monitoring the Security Appliance - Configuring and Managing Logs. Information about configuring syslog on the FWSM for Cisco Catalyst 6500 Series switches and Cisco 7600 Series routers is available in Configuring Monitoring and Logging on the Cisco FWSM. In the following example, the show logging | grep regex command extracts syslog messages from the logging buffer on the firewall. These messages provide additional information about denied packets that could indicate potential attempts to exploit these vulnerabilities. It is possible to use different regular expressions with the grep keyword to search for specific data in the logged messages. SNMP Inspection firewall#show logging | grep 416001 Jun 05 2008 22:03:49: %ASA-4-416001: Dropped UDP SNMP packet from outside:192.168.60.63/32769 to inside:192.168.60.42/161; version (3) is not allowed thru the firewall Jun 05 2008 22:03:50: %ASA-4-416001: Dropped UDP SNMP packet from outside:192.168.60.63/32769 to inside:192.168.60.42/161; version (3) is not allowed thru the firewall Jun 05 2008 22:03:51: %ASA-4-416001: Dropped UDP SNMP packet from outside:192.168.60.63/32769 to inside:192.168.60.42/161; version (3) is not allowed thru the firewall Jun 05 2008 22:03:52: %ASA-4-416001: Dropped UDP SNMP packet from outside:192.168.60.63/32769 to inside:192.168.60.42/161; version (3) is not allowed thru the firewall Jun 05 2008 22:03:53: %ASA-4-416001: Dropped UDP SNMP packet from outside:192.168.60.63/32769 to inside:192.168.60.42/161; version (3) is not allowed thru the firewall Jun 05 2008 22:03:54: %ASA-4-416001: Dropped UDP SNMP packet from outside:192.168.60.63/32769 to inside:192.168.60.42/161; version (3) is not allowed thru the firewall firewall# With SNMP inspection enabled, the show service-policy command will identify the number of SNMP packets inspected and dropped by this feature. Example output for show service-policy follows: firewall#show service-policy | include snmp Inspect: snmp deny_snmpv3, packet 236, drop 6, reset-drop 0 firewall# Identification: Spoofing Protection Using Unicast Reverse Path Forwarding Firewall syslog message 106021 will be generated for packets denied by Unicast RPF. Additional information about this syslog message is available in Cisco Security Appliance System Log Message - 106021. Information about configuring syslog for the Cisco ASA 5500 Series Adaptive Security Appliance or the Cisco PIX 500 Series Security Appliance is available in Monitoring the Security Appliance - Configuring and Managing Logs. Information about configuring syslog on the FWSM for Cisco Catalyst 6500 Series switches and Cisco 7600 Series routers is available in Configuring Monitoring and Logging on the Cisco FWSM. In the following example, the show logging | grep regex command extracts syslog messages from the logging buffer on the firewall. These messages provide additional information about denied packets that could indicate potential attempts to exploit the vulnerabilities described in this document. It is possible to use different regular expressions with the grep keyword to search for specific data in the logged messages. Additional information about regular expression syntax is available in Creating a Regular Expression. firewall#show logging | grep 106021 Jun 05 2008 00:15:13: %ASA-1-106021: Deny UDP reverse path check from 192.168.60.1 to 192.168.60.100 on interface outside Jun 05 2008 00:15:13: %ASA-1-106021: Deny UDP reverse path check from 192.168.60.1 to 192.168.60.100 on interface outside Jun 05 2008 00:15:13: %ASA-1-106021: Deny TCP reverse path check from 192.168.60.1 to 192.168.60.100 on interface outside firewall# The show asp drop command can also identify the number of packets that Unicast RPF has dropped, as shown in the following example: firewall#show asp drop frame rpf-violated Reverse-path verify failed 11 firewall# In the preceding example, Unicast RPF has dropped 11 IP packets received on interfaces with Unicast RPF configured. Absence of output indicates that the firewall has not dropped packets due to Unicast RPF failure. For additional information about debugging dropped packets or connections for accelerated security paths, reference the Cisco Security Appliance Command Reference for show asp drop. Cisco Intrusion Prevention System Mitigation: Cisco IPS Signature Event Actions Administrators can use the Cisco Intrusion Prevention System (IPS) appliances and services modules to provide threat detection and help prevent attempts to exploit the vulnerability described in this document. Starting with signature update S338 for sensors running Cisco IPS version 6.x or 5.x, the vulnerability described in this document can be detected by signature 6546/0 (Signature Name: SNMPv3 Malformed Authentication Attempt). Signature 6546/0 is enabled by default, triggers a High severity event, has a signature fidelity rating (SFR) of 85, and is configured with a default event action of Produce Alert. Signature 6546/0 fires when an SNMPv3 request with a one byte password hash is detected. Firing of this signature may indicate a potential exploit of the vulnerability. Administrators can configure Cisco IPS sensors to perform an event action when an attack is detected. The configured event action performs preventive or deterrent controls to help protect against an attack that is attempting to exploit the vulnerability. Exploits that are easily spoofed may cause a configured event action to inadvertently deny traffic from trusted sources. Cisco IPS sensors are most effective when deployed in inline protection mode combined with the use of an event action. Automatic Threat Prevention for Cisco IPS 6.x sensors deployed in inline protection mode provides threat prevention against an attack that is attempting to exploit the vulnerability. Threat prevention is achieved through a default override that performs an event action for triggered signatures with a riskRatingValue greater than 90. Cisco IPS 5.x sensors that are deployed in inline protection mode require an event action configured on a per-signature basis. Alternatively, administrators can configure an override that can perform an event action for any signatures that are triggered and are calculated as a high-risk threat. Using an event action on sensors deployed in inline protection mode provides the most effective exploit prevention. For additional information about the risk rating and threat rating calculation, reference Risk Rating and Threat Rating: Simplify IPS Policy Management. Identification: IPS Signature Events Signature: SNMPv3 Malformed Authentication Attempt IPS#show events alert evIdsAlert: eventId=1212707853148090324 vendor=Cisco severity=high originator: hostId: IPS4240 appName: sensorApp appInstanceId: 408 time: Jun 11, 2008 02:03:16 UTC offset=-300 timeZone=CDT signature: description=SNMPv3 Malformed Authentication Attempt id=6546 version=S338 subsigId: 0 sigDetails: 1 Byte Password marsCategory: Penetrate/GuessPassword/SNMP interfaceGroup: vs0 vlan: 0 participants: attacker: addr: 192.168.189.1 locality=OUT port: 36246 target: addr: 192.168.189.128 locality=OUT port: 161 os: idSource=unknown type=unknown relevance=unknown triggerPacket: riskRatingValue: 75 targetValueRating=medium threatRatingValue: 75 interface: ge0_3 protocol: udp Cisco Security Monitoring, Analysis, and Response System Identification: Cisco Security Monitoring, Analysis, and Response System Incidents The Cisco Security Monitoring, Analysis, and Response System (Cisco Security MARS) appliance can create incidents on events for the vulnerability using IPS signature 6546/0 (Signature Name: SNMPv3 Malformed Authentication Attempt). After the S338 dynamic signature update has been downloaded, using keyword NR-6546 for IPS signature 6546/0 and a query type of All Matching Events on the Cisco Security MARS appliance will provide a report that lists the incidents created by the IPS signature. The following screen shot shows the values used to query for events created by the IPS signature related to this vulnerability: The following screen shot shows the query results for this vulnerability created by the Cisco Security MARS appliance: Beginning with the 4.3.1 and 5.3.1 releases of Cisco Security MARS appliances, support for the Cisco IPS dynamic signature updates feature has been added. This feature downloads new signatures from Cisco.com or from a local web server, correctly processes and categorizes received events that match those signatures, and includes them in inspection rules and reports. These updates provide event normalization and event group mapping, and they also enable the MARS appliance to parse new signatures from the IPS devices. Caution: If dynamic signature updates are not configured, events that match these new signatures appear as unknown event type in queries and reports. MARS will not include these events in inspection rules, thus incidents may not be created for potential threats or attacks that occur within the network. By default, this feature is enabled but requires configuration. If it is not configured, the following Cisco Security MARS rule will be triggered: System Rule: CS-MARS IPS Signature Update Failure When this feature is enabled and configured, administrators can determine the current signature version downloaded by MARS by selecting Help > About and reviewing the IPS Signature Version value. Additional information about and instructions for configuring dynamic signature updates are available at for the Cisco Security MARS 4.3.1 and 5.3.1 releases. Additional Information THIS DOCUMENT IS PROVIDED ON AN "AS IS" BASIS AND DOES NOT IMPLY ANY KIND OF GUARANTEE OR WARRANTY, INCLUDING THE WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR USE. YOUR USE OF THE INFORMATION ON THE DOCUMENT OR MATERIALS LINKED FROM THE DOCUMENT IS AT YOUR OWN RISK. CISCO RESERVES THE RIGHT TO CHANGE OR UPDATE THIS DOCUMENT AT ANY TIME. Revision History Revision 1.1 2008-June-11 Added IPS Mitigation and CS-MARS Identifications sections. Revision 1.0 2008-June-10 Initial public release Cisco Security Procedures Complete information on reporting security vulnerabilities in Cisco products, obtaining assistance with security incidents, and registering to receive security information from Cisco, is available on Cisco's worldwide website at http://www.cisco.com/web/about/security/psirt/security_vulnerability_policy.html. This includes instructions for press inquiries regarding Cisco security notices. All Cisco security advisories are available at http://www.cisco.com/go/psirt. Related Information - Cisco Applied Mitigation Bulletins - Cisco Security Center - Cisco IOS NetFlow - Home Page on Cisco.com - Cisco IOS NetFlow White Papers - NetFlow Performance Analysis - A Security-Oriented Approach to IP Addressing - Cisco Firewall Products - Home Page on Cisco.com - Unicast Reverse Path Forwarding Enhancements for the Internet Service Provider - Common Vulnerabilities and Exposures (CVE) - Cisco Guide to Harden Cisco IOS Devices - Cisco 6.x Intrusion Prevention System - Cisco IPS 6.x Signature Downloads - Cisco IPS Signature Search Page - Cisco Security Monitoring, Analysis, and Response System