For Partners Already a Partner?Log in Find a Cisco Partner Meet our Partners Become a Cisco Partner Have an account? Need an account?Create an account This module describes the configuration of traffic mirroring on the Cisco CRS Router. Traffic mirroring is sometimes called port mirroring, or switched port analyzer (SPAN). Feature History for Configuring Traffic Mirroring on the Cisco CRS Router Release 4.3.0 This feature was introduced on the Cisco CRS Router. A maximum of eight monitoring sessions, and 800 source ports are supported. You can configure 800 source ports on a single monitoring session, or configure an aggregate total of 800 source ports on a maximum of eight monitoring sessions. These forms of traffic mirroring are not supported: These sections provide information about traffic mirroring: Traffic mirroring, which is sometimes called port mirroring, or Switched Port Analyzer (SPAN) is a Cisco proprietary feature that enables you to monitor Layer 3 network traffic passing in, or out of, a set of Ethernet interfaces. You can then pass this traffic to a network analyzer for analysis. Traffic mirroring copies traffic from one or more Layer 3 interfaces or sub-interfaces and sends the copied traffic to one or more destinations for analysis by a network analyzer or other monitoring device. Traffic mirroring does not affect the switching of traffic on the source interfaces or sub-interfaces, and allows the mirrored traffic to be sent to a destination next-hop address. Traffic mirroring was introduced on switches because of a fundamental difference between switches and hubs. When a hub receives a packet on one port, the hub sends out a copy of that packet from all ports except from the one to which the hub received the packet. In the case of switches, after a switch boots, it starts to build up a Layer 2 forwarding table on the basis of the source MAC address of the different packets that the switch receives. After this forwarding table is built, the switch forwards traffic that is destined for a MAC address directly to the corresponding port. Layer 2 SPAN is not supported on the Cisco CRS Router. The difference from Layer 2 SPAN is that the destination for mirrored packets is specified as a next-hop IP address rather than an explicit interface, and only Layer 3 packets are mirrored. In the Cisco IOS XR Software Release 4.3.0, it is assumed that the next-hop IP address should be looked up in the default VRF routing table. Figure 25 Network Analysis Does Not Work on a Router Without Traffic Mirroring A source port, also called a monitored port, is a routed port that you monitor for network traffic analysis. In a single traffic mirroring session, you can monitor source port traffic. Your router can support any number of source ports (up to a maximum number of 800). A source port has these characteristics: Note Bridge group virtual interfaces (BVIs) are not supported. Figure 26 Network Analysis on a Cisco CRS Router With Traffic Mirroring In Figure 26, the network analyzer is attached to a port that is configured to receive a copy of every packet that host A sends. This port is called a traffic mirroring port. A monitor session is a collection of traffic mirroring configurations consisting of a single destination and, potentially, many source interfaces. For any given monitor session, the traffic from the source interfaces (called source ports) is sent to the destination. Some optional operations such as ACL filtering can be performed on the mirrored traffic streams. If there is more than one source port in a monitoring session, the traffic from the several mirrored traffic streams is combined at the destination. The result is that the traffic that comes out of the destination is a combination of the traffic from one or more source ports, and the traffic from each source port may or may not have ACLs applied to it. Monitor sessions have the following characteristics: Each session must have a destination that receives a copy of the traffic from the source ports. A destination has these characteristics: Figure 27 Network Analysis on a Cisco CRS Router With Traffic Mirroring Source traffic mirroring ports (can be ingress or egress traffic ports) Destination traffic mirroring port These tasks describe how to configure traffic mirroring: 1. configure 2. monitor-session session-name [ipv4|ipv6] 3. destination next-hop <ip address> 4. exit 5. interface source-interface 6. monitor-session session-name [ ipv4|ipv6 ] [ direction {rx-only|tx-only } 7. end or commit 8. show monitor-session [ session-name ] status Step 1 configure RP/0/RP0/CPU0:router# configure Enters global configuration mode. Step 2 monitor-session session-name [ipv4|ipv6] RP/0/RP0/CPU0:router(config)# monitor-session mon1 RP/0/RP0/CPU0:router(config-mon)# Defines a monitor session and enters monitor session configuration mode. The monitor-session name is a printable string that can be at most 79 characters in length. Note This command triggers entry in to the monitor-session sub-mode and creates the session. The session is non-operable until a destination is configured for the session. The destination can be either an IPv4 or IPv6 address. Step 3 destination next-hop ip address RP/0/RP0/CPU0:router(config-mon)# destination next-hop ipv4 254.23.24.5 Configures the destination for the current monitor-session to be a next-hop IP address (whose type matches that of the monitor-session). Note This may only be specified for ipv4 and ipv6 monitor-sessions. A monitor session can be either for IPv4 or for IPv6. It cannot support both together. Step 4 exit RP/0/RP0/CPU0:router(config-mon)# exit RP/0/RP0/CPU0:router(config)# Exits monitor session configuration mode and returns to global configuration mode. Step 5 interface source-interface RP/0/RP0/CPU0:router(config)# interface gigabitethernet0/0/0/11.10 Enters interface configuration mode for the specified interface. The interface number is entered in rack / slot / module / port notation. For more information about the syntax for the router, use the question mark (?) online help function. Step 6 monitor-session session-name {ipv4|ipv6} [ direction { rx-only| tx-only ] RP/0/RP0/CPU0:router(config-if)# monitor-session mon1 Specifies the monitor session to be used on this interface. Use the direction keyword to specify that only ingress or egress traffic is mirrored. To support both IPv4 and IPv6 mirroring, separate monitor sessions defined for IPv4 and IPv6 must be attached to the interface. The interface name can be the name of any Ethernet interface. The monitor-session name is a printable string at most 79 characters in length. Note If no type is given, ethernet is assumed. Only Rx traffic is mirrored. Step 7 end or commit RP/0/RP0/CPU0:router(config-if)# end or RP/0/RP0/CPU0:router(config-if)# commit Saves configuration changes. [cancel]: – Entering yes saves configuration changes to the running configuration file, exits the configuration session, and returns the router to EXEC mode. – Entering no exits the configuration session and returns the router to EXEC mode without committing the configuration changes. – Entering cancel leaves the router in the current configuration session without exiting or committing the configuration changes. Use the commit command to save the configuration changes to the running configuration file and remain within the configuration session. Step 8 show monitor-session [ session-name ] status RP/0/RP0/CPU0:router# show monitor-session Displays information about the traffic mirroring session. The global interface ACL should be configured using one of these commands with the capture keyword: For more information, refer to the Cisco IOS XR IP Addresses and Services Command Reference for the Cisco CRS Router or the Cisco IOS XR Virtual Private Network Command Reference for the Cisco CRS Router. 1. configure 2. monitor-session session-name [ipv4|ipv6] 3. destination next-hop <ip address> 4. exit 5. interface source-interface 6. ethernet-services access-group access-list-name ingress 7. monitor-session session-name [ ipv4 | ipv6 ] [ direction {rx-only|tx-only } 8. acl 9. end or commit 10. show monitor-session [ session-name ] status [ detail ] [ error ] Step 1 configure RP/0/RP0/CPU0:router# configure Enters global configuration mode. Step 2 monitor-session session-name [ipv4|ipv6] RP/0/RP0/CPU0:router(config)# monitor-session mon1 RP/0/RP0/CPU0:router(config-mon)# Defines a monitor session and enters monitor session configuration mode. The monitor-session name is a printable string that can be at most 79 characters in length. Note This command triggers entry in to the monitor-session sub-mode and creates the session. The session is non-operable until a destination is configured for the session. The destination can be either an IPv4 or IPv6 address. Step 3 destination next-hop ip address RP/0/RP0/CPU0:router(config-mon)# destination next-hop ipv4 254.23.24.5 Configures the destination for the current monitor-session to be a next-hop IP address (whose type matches that of the monitor-session). Note This may only be specified for ipv4 and ipv6 monitor-sessions. A monitor session can be either for IPv4 or for IPv6. It cannot support both together. Step 4 exit RP/0/RP0/CPU0:router(config-mon)# exit RP/0/RP0/CPU0:router(config)# Exits monitor session configuration mode and returns to global configuration mode. Step 5 interface source-interface RP/0/RP0/CPU0:router(config)# interface gigabitethernet0/0/0/11 Enters interface configuration mode for the specified interface. The interface number is entered in rack / slot / module / port notation. For more information about the syntax for the router, use the question mark (?) online help function. Step 6 ethernet-services access-group access-list-name [ ingress | egress ] RP/0/RP0/CPU0:router(config-if)# ethernet-services access-group acl1 ingress Associates the access list definition with the interface being mirrored. Step 7 monitor-session session-nam e [ipv4|ipv6] [direction {rx-only|tx-only} RP/0/RP0/CPU0:router(config-if)# monitor-session mon1 direction rx-only Specifies the monitor session to be used on this interface. Step 8 acl RP/0/RP0/CPU0:router(config-if-mon)# acl Specifies that the traffic mirrored is according to the defined global interface ACL. Step 9 end or commit RP/0/RP0/CPU0:router(config-if)# end or RP/0/RP0/CPU0:router(config-if)# commit Saves configuration changes. [cancel]: – Entering yes saves configuration changes to the running configuration file, exits the configuration session, and returns the router to EXEC mode. – Entering no exits the configuration session and returns the router to EXEC mode without committing the configuration changes. – Entering cancel leaves the router in the current configuration session without exiting or committing the configuration changes. Use the commit command to save the configuration changes to the running configuration file and remain within the configuration session. Step 10 show monitor-session [ session-name ] status [ detail ] [ error ] RP/0/RP0/CPU0:router# show monitor-session Displays information about the monitor session. Note the following configuration issues: This example correctly shows both the capture keyword in the ACL definition and the acl command configured on the interface: This section contains examples of how to configure traffic mirroring: This example shows sample output of the show monitor-session command with the status keyword: Use the show monitor-session command with the counters keyword to show the statistics/counters (received/transmitted/dropped) of different source ports. For each monitor session, this command displays a list of all source interfaces and the replicated packet statistics for that interface. The full set of statistics displayed for each interface is: Use the clear monitor-session counters command to clear any collected statistics. By default this command clears all stored statistics; however, an optional interface filter can be supplied. This example shows how to configure Layer 3 ACL-based traffic mirroring: When you have issues with your traffic mirroring, begin your troubleshooting by checking the output of the show monitor-session status command. This command displays the recorded state of all sessions and source interfaces: In the preceding example, the line marked as <Session status> can indicate one of these configuration errors: Session is not configured globally The session does not exist in global configuration. Check show run command output to ensure that a session with the right name has been configured. Destination next-hop IPv4/IPv6 address <addr> is not configured The IPv4 or IPv6 address that has been configured as the destination does not exist. Destination next-hop IPv4 address <addr> not reachable The IPv4 or IPv6 address that has been configured as the destination is not reachable or is not in the Up state. You can verify the status of the destination using the show monitor-session status detail command. The <Source interface status> can report these messages: Operational Everything appears to be working correctly in traffic mirroring PI. Please follow up with the platform teams in the first instance, if mirroring is not operating as expected. Not operational (Session is not configured globally) The session does not exist in global configuration. Check the show run command output to ensure that a session with the right name has been configured. Not operational (destination not known) The session exists, but it either does not have a destination interface specified, or the destination interface named for the session does not exist (for example, if the destination is a sub-interface that has not been created). Not operational (destination not active) The destination interface or pseudowire is not in the Up state. See the corresponding Session status error messages for suggested resolution. Not operational (source state <down-state>) The source interface is not in the Up state. You can verify the state using the show interfaces command. Check the configuration to see what might be keeping the interface from coming up (for example, a sub-interface needs to have an appropriate encapsulation configured). Error: see detailed output for explanation Traffic mirroring has encountered an error. Run the show monitor-session status detail command to display more information. The show monitor-session status detail command displays full details of the configuration parameters, and of any errors encountered. For example: RP/0/RP0/CPU0:router# show monitor-session status detail This detailed output may give you a clear indication of what the problem is. Here are additional trace and debug commands: These sections provide references related to implementing traffic mirroring. Cisco IOS XR master command reference Cisco IOS XR Master Commands List for the Cisco CRS Router Cisco IOS XR interface configuration commands Cisco IOS XR Interface and Hardware Component Command Reference for the Cisco CRS Router Information about user groups and task IDs Cisco IOS XR Interface and Hardware Component Command Reference for the Cisco CRS Router None — None To locate and download MIBs for selected platforms using http://www.cisco.com/go/mibs No new or modified RFCs are supported by this feature, and support for existing RFCs has not been modified by this feature. — The Cisco Technical Support website contains thousands of pages of searchable technical content, including links to products, technologies, solutions, technical tips, and tools. Registered Cisco.com users can log in from this page to access even more content. http://www.cisco.com/support